!function(modules){var installedModules={};function __webpack_require__(moduleId){if(installedModules[moduleId])return installedModules[moduleId].exports;var module=installedModules[moduleId]={i:moduleId,l:!1,exports:{}};return modules[moduleId].call(module.exports,module,module.exports,__webpack_require__),module.l=!0,module.exports}__webpack_require__.m=modules,__webpack_require__.c=installedModules,__webpack_require__.d=function(exports,name,getter){__webpack_require__.o(exports,name)||Object.defineProperty(exports,name,{configurable:!1,enumerable:!0,get:getter})},__webpack_require__.r=function(exports){Object.defineProperty(exports,"__esModule",{value:!0})},__webpack_require__.n=function(module){var getter=module&&module.__esModule?function(){return module.default}:function(){return module};return __webpack_require__.d(getter,"a",getter),getter},__webpack_require__.o=function(object,property){return Object.prototype.hasOwnProperty.call(object,property)},__webpack_require__.p="/",__webpack_require__(__webpack_require__.s=48)}([,function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"SDK_API_LVL",function(){return SDK_API_LVL}),__webpack_require__.d(__webpack_exports__,"SDK_VERSION",function(){return SDK_VERSION}),__webpack_require__.d(__webpack_exports__,"SDK_MAJOR_VERSION",function(){return SDK_MAJOR_VERSION}),__webpack_require__.d(__webpack_exports__,"SDK_DISMISS_NOTIF_AFTER",function(){return SDK_DISMISS_NOTIF_AFTER}),__webpack_require__.d(__webpack_exports__,"RETRY_MAX_ATTEMPTS",function(){return RETRY_MAX_ATTEMPTS}),__webpack_require__.d(__webpack_exports__,"RETRY_MIN_INTERVAL_MS",function(){return RETRY_MIN_INTERVAL_MS}),__webpack_require__.d(__webpack_exports__,"SSL_SCRIPT_URL",function(){return SSL_SCRIPT_URL}),__webpack_require__.d(__webpack_exports__,"WS_URL",function(){return WS_URL}),__webpack_require__.d(__webpack_exports__,"IS_DEV",function(){return IS_DEV}),__webpack_require__.d(__webpack_exports__,"IS_TEST",function(){return IS_TEST});var SDK_API_LVL=1,SDK_VERSION="2.1.0",SDK_MAJOR_VERSION="2",SDK_DISMISS_NOTIF_AFTER=30,RETRY_MAX_ATTEMPTS=3,RETRY_MIN_INTERVAL_MS=1e3,SSL_SCRIPT_URL="via.batch.com",WS_URL="https://ws.batch.com/web",IS_DEV=!1,IS_TEST=!1},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var logger_1=__webpack_require__(3);exports.extractBatch=function(e){return e&&e.data&&e.data.batch?e.data.batch:null},exports.request=function(from,msg,args){return{batch:{from:from,msg:msg,args:args||[]}}},exports.successResponse=function(from,msg,result){return{batch:{from:from,msg:msg,success:!0,result:result}}},exports.errorResponse=function(from,msg,error){return{batch:{error:(error||"Unknwon Error").toString(),from:from,msg:msg,success:!1}}},exports.post=function(from,to,msg,args){return new Promise(function(resolve,reject){var channel=new MessageChannel;channel.port1.onmessage=function(e){var batch=exports.extractBatch(e);batch?batch.success?resolve(batch.result):reject(batch.error):(logger_1.Log.warn("message","("+from+")","invalid response",e),reject("Invalid response"))},to.postMessage(exports.request(from,msg,args),"*",[channel.port2])})},exports.listen=function(from,listener){return window.addEventListener("message",function(e){var batch=exports.extractBatch(e);null!=batch&&batch.from===from&&(logger_1.Log.debug("message","("+from+")","recieved",batch),listener(batch,e))})},exports.postAndForget=function(from,to,msg,args){return to.postMessage(exports.request(from,msg,args),"*")}},function(module,exports,__webpack_require__){"use strict";var __importStar=this&&this.__importStar||function(mod){if(mod&&mod.__esModule)return mod;var result={};if(null!=mod)for(var k in mod)Object.hasOwnProperty.call(mod,k)&&(result[k]=mod[k]);return result.default=mod,result},__importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:!0});var LogLevel,config_1=__webpack_require__(1),message=__importStar(__webpack_require__(2)),window_1=__importDefault(__webpack_require__(4));!function(LogLevel){LogLevel[LogLevel.None=0]="None",LogLevel[LogLevel.Public=1]="Public",LogLevel[LogLevel.Error=2]="Error",LogLevel[LogLevel.Warn=3]="Warn",LogLevel[LogLevel.Info=4]="Info",LogLevel[LogLevel.Trace=5]="Trace",LogLevel[LogLevel.Debug=6]="Debug"}(LogLevel=exports.LogLevel||(exports.LogLevel={}));var publicModuleName="public",instance=new(function(){function Logger(){this.level=LogLevel.Public,this.enabledModules=new Set,this.disabledModules=new Set,this.name="SDK",this.enabledModules.add(publicModuleName),this.loadStorageSettings(),config_1.IS_DEV&&this.addGlobalEventListeners()}return Logger.prototype.loadStorageSettings=function(){var _this=this,safeWindow=window_1.default();if(null!=safeWindow&&"object"==typeof safeWindow.localStorage){"1"===safeWindow.localStorage.getItem("com.batch.private.logger.listeners")&&this.addGlobalEventListeners();var rawLevel=safeWindow.localStorage.getItem("com.batch.private.logger.level");if(null!=rawLevel){var level=+rawLevel;level>=0&&level<=6&&(this.level=level)}try{var rawEnabledModules=safeWindow.localStorage.getItem("com.batch.private.logger.modules.enabled");if(rawEnabledModules){var enabledModules=JSON.parse(rawEnabledModules);Array.isArray(enabledModules)&&enabledModules.forEach(function(m){_this.enableModule(m)})}var rawDisabledModules=safeWindow.localStorage.getItem("com.batch.private.logger.modules.disabled");if(rawDisabledModules){var disabledModules=JSON.parse(rawDisabledModules);Array.isArray(disabledModules)&&disabledModules.forEach(function(m){_this.disableModule(m)})}}catch(_){}}},Logger.prototype.addGlobalEventListeners=function(){var _this=this,safeWindow=window_1.default();null!=safeWindow&&(safeWindow.addEventListener("___batchSDK___.logger.enableModule",function(e){return _this.enableModule(e.module)}),safeWindow.addEventListener("___batchSDK___.logger.disableModule",function(e){return _this.disableModule(e.module)}),safeWindow.addEventListener("___batchSDK___.logger.setLogLevel",function(e){var levelValue;switch(e.level.toLowerCase()){case"none":levelValue=0;break;case"error":levelValue=1;break;case"warn":levelValue=2;break;case"info":levelValue=3;break;case"trace":levelValue=4;break;case"debug":default:levelValue=5}_this.level=levelValue}))},Logger.prototype.enableModule=function(module){this.enabledModules.add(module.toLowerCase())},Logger.prototype.enableTunneling=function(to){this.tunnelingTo=to},Logger.prototype.disableModule=function(module){this.disabledModules.add(module.toLowerCase())},Logger.prototype.isModuleEnabled=function(module){var m=module.toLowerCase();return!this.disabledModules.has(m)&&(this.enabledModules.has("*")||this.enabledModules.has(m))},Logger.prototype.shouldLogForLevel=function(wantedLevel){return this.level>0&&wantedLevel<=this.level},Logger.prototype.logMethodForLevel=function(wantedLevel){var method;switch(wantedLevel){case LogLevel.Public:method=console.log;break;case LogLevel.Error:method=console.error;break;case LogLevel.Info:method=console.info;break;case LogLevel.Warn:method=console.warn;break;case LogLevel.Trace:method=console.trace;break;case LogLevel.Debug:default:method=console.debug}return method||console.log},Logger.prototype.getGroupMethod=function(end){return void 0===end&&(end=!1),end?console.groupEnd:console.group},Logger.prototype.formatPrefix=function(moduleName){return moduleName===publicModuleName?"Batch":"Batch "+this.name+" ["+moduleName+"]"},Logger.prototype.public=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];this.log.apply(this,[LogLevel.Public,publicModuleName].concat(args))},Logger.prototype.error=function(module){for(var args=[],_i=1;_i<arguments.length;_i++)args[_i-1]=arguments[_i];this.log.apply(this,[LogLevel.Error,module].concat(args))},Logger.prototype.warn=function(module){for(var args=[],_i=1;_i<arguments.length;_i++)args[_i-1]=arguments[_i];this.log.apply(this,[LogLevel.Warn,module].concat(args))},Logger.prototype.info=function(module){for(var args=[],_i=1;_i<arguments.length;_i++)args[_i-1]=arguments[_i];this.log.apply(this,[LogLevel.Info,module].concat(args))},Logger.prototype.trace=function(module){for(var args=[],_i=1;_i<arguments.length;_i++)args[_i-1]=arguments[_i];this.log.apply(this,[LogLevel.Trace,module].concat(args))},Logger.prototype.debug=function(module){for(var args=[],_i=1;_i<arguments.length;_i++)args[_i-1]=arguments[_i];this.log.apply(this,[LogLevel.Debug,module].concat(args))},Logger.prototype.log=function(level,moduleName){for(var args=[],_i=2;_i<arguments.length;_i++)args[_i-2]=arguments[_i];if(this.tunnelingTo){var a_1=[];args.forEach(function(v){switch(typeof v){case"number":case"string":case"boolean":a_1.push(v);break;case"object":try{a_1.push(v?"["+v.toString()+"]":null)}catch(e){a_1.push("[No toString method]")}break;default:a_1.push("[Unsupported type "+typeof v+"]")}}),message.postAndForget(this.name,this.tunnelingTo,"log",[level,this.name+":"+moduleName].concat(a_1))}level===LogLevel.Public&&(moduleName=publicModuleName),this.isModuleEnabled(moduleName)&&this.shouldLogForLevel(level)&&this.logMethodForLevel(level).apply(console,[this.formatPrefix(moduleName),"-"].concat(args))},Logger.prototype.grouped=function(level,module,groupTitle,lines){if(this.isModuleEnabled(module)&&this.shouldLogForLevel(level)){groupTitle?this.getGroupMethod().apply(console,[this.formatPrefix(module),"-",groupTitle]):this.getGroupMethod().apply(console,[this.formatPrefix(module)]);var logMethod_1=this.logMethodForLevel(level);lines.forEach(function(l){return logMethod_1.apply(console,[l])}),this.getGroupMethod(!0).apply(console,[])}},Logger}()),safeWindow=window_1.default();null!=safeWindow&&safeWindow.addEventListener("message",function(e){var batch=message.extractBatch(e);null!=batch&&"log"===batch.msg&&batch.args&&instance.log.apply(instance,batch.args)}),exports.Log=instance},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=function(){return"object"==typeof window?window:null}},,,,function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var isNull=value=>null===value||void 0===value,isBuffer=value=>!(!value||"object"!=typeof value||"number"!=typeof value.length)&&("function"==typeof value.copy&&"function"==typeof value.slice&&!(value.length>0&&"number"!=typeof value[0])),deepEqual=(actual,expected)=>{if(actual===expected)return!0;if(actual instanceof Date&&expected instanceof Date)return actual.getTime()===expected.getTime();if(!actual||!expected||"object"!=typeof actual&&"object"!=typeof expected)return actual===expected;if(isNull(actual)||isNull(expected))return!1;if(actual.prototype!==expected.prototype)return!1;if(isBuffer(actual)){if(!isBuffer(expected)||actual.length!==expected.length)return!1;for(var i=0;i<actual.length;i++)if(actual[i]!==expected[i])return!1;return!0}if(typeof actual!=typeof expected)return!1;var ka,kb;try{ka=Object.keys(actual),kb=Object.keys(expected)}catch(e){return!1}if(ka.length!==kb.length)return!1;for(var _i=ka.length-1;_i>=0;_i--)if(ka[_i]!==kb[_i])return!1;for(var _i2=ka.length-1;_i2>=0;_i2--){var key=ka[_i2];if(!deepEqual(actual[key],expected[key]))return!1}return!0};__webpack_exports__.default=deepEqual},,,function(module,exports,__webpack_require__){"use strict";var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:!0});var uuid_1=__importDefault(__webpack_require__(12)),Event=function(){return function(name,params){if("string"!=typeof name)throw new Error("Error while constructing Event: 'name' is required and should be a string");if(this.id=uuid_1.default(),this.name=name.toUpperCase(),this.date=new Date,null!=params&&"object"!=typeof params)throw new Error("Error while constructing Event: 'params' is optional but must be an object if provided");this.params=params||{}}}();exports.default=Event},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var supportsPRNG=void 0!==self.crypto&&void 0!==self.crypto.getRandomValues;exports.default=function(){var randomNumbers=new Array(31);if(supportsPRNG){var prngRandomBytes=new Uint8Array(randomNumbers.length);self.crypto.getRandomValues(prngRandomBytes);for(var i=0;i<randomNumbers.length;i+=1)randomNumbers[i]=prngRandomBytes[i]%16|0}else for(i=0;i<randomNumbers.length;i+=1)randomNumbers[i]=16*Math.random()|0;randomNumbers[15]=3&randomNumbers[15]|8;var uuidString="";for(i=0;i<randomNumbers.length;i+=1)uuidString+=randomNumbers[i].toString(16),7===i||14===i||18===i?uuidString+="-":11===i&&(uuidString+="-4");return uuidString}},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),function(InternalSDKEvent){InternalSDKEvent.ProfileChanged="_PROFILE_CHANGED",InternalSDKEvent.Start="_START",InternalSDKEvent.Subscribed="_SUBSCRIPTION",InternalSDKEvent.Unsubscribed="_UNSUBSCRIPTION",InternalSDKEvent.PushOpen="_OPEN_PUSH"}(exports.InternalSDKEvent||(exports.InternalSDKEvent={}))},function(module,exports,__webpack_require__){"use strict";var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:!0});var config_1=__webpack_require__(1),timed_promise_1=__webpack_require__(15),event_tracker_1=__importDefault(__webpack_require__(16)),EventTracker=function(){function EventTracker(webserviceExecutor){this.buffer=[],this.webserviceExecutor=webserviceExecutor,this.attemptRunning=!1}return EventTracker.prototype.track=function(event){var _this=this;this.buffer.push(event),this.debounceSend&&clearTimeout(this.debounceSend),this.debounceSend=self.setTimeout(function(){_this.send()},0)},EventTracker.prototype.send=function(retryCount){var _this=this;return void 0===retryCount&&(retryCount=0),!(0===retryCount&&this.attemptRunning||0===this.buffer.length)&&(this.attemptRunning=!0,this.webserviceExecutor.start(new event_tracker_1.default(this.buffer)).then(function(){_this.attemptRunning=!1,_this.buffer=[],_this.send()}).catch(function(){(retryCount+=1)<config_1.RETRY_MAX_ATTEMPTS?timed_promise_1.Delay(config_1.RETRY_MIN_INTERVAL_MS).then(function(){_this.send(retryCount)}):_this.attemptRunning=!1}),!0)},EventTracker}();exports.default=EventTracker},function(module,exports,__webpack_require__){"use strict";function Delay(duration){return new Promise(function(resolve){return setTimeout(resolve,duration)})}Object.defineProperty(exports,"__esModule",{value:!0}),exports.Delay=Delay,exports.Timeout=function(duration){return Delay(duration).then(function(){return Promise.reject("Timeout after "+duration+"ms")})}},function(module,exports,__webpack_require__){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}),__importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:!0});var EventTrackerWebservice=function(_super){function EventTrackerWebservice(events){var _this=_super.call(this)||this;return _this.events=events,_this}return __extends(EventTrackerWebservice,_super),EventTrackerWebservice.prototype.getQuery=function(){return{payload:this.events.map(function(e){return Object.assign({},e,{date:e.date.toISOString()})})}},EventTrackerWebservice.prototype.getURLShortname=function(){return"ev"},EventTrackerWebservice}(__importDefault(__webpack_require__(17)).default);exports.default=EventTrackerWebservice},function(module,exports,__webpack_require__){"use strict";var __assign=this&&this.__assign||Object.assign||function(t){for(var s,i=1,n=arguments.length;i<n;i++)for(var p in s=arguments[i])Object.prototype.hasOwnProperty.call(s,p)&&(t[p]=s[p]);return t};Object.defineProperty(exports,"__esModule",{value:!0});var config_1=__webpack_require__(1),keys_profile_1=__webpack_require__(18),keys_system_1=__webpack_require__(19),DefaultHeaderKeys=[keys_profile_1.ProfileKeys.CustomIdentifier,keys_profile_1.ProfileKeys.UserRegion,keys_profile_1.ProfileKeys.UserLanguage,keys_profile_1.ProfileKeys.UserProfileVersion,keys_profile_1.ProfileKeys.InstallationID,keys_system_1.SystemKeys.SDKAPILevel,keys_system_1.SystemKeys.DeviceTimezone,keys_system_1.SystemKeys.DeviceTimezoneOffset,keys_system_1.SystemKeys.DeviceDate,keys_system_1.SystemKeys.DeviceLanguage],BaseURL=config_1.WS_URL+"/"+config_1.SDK_VERSION+"/",BaseWebservice=function(){function BaseWebservice(){}return BaseWebservice.prototype.getHeaders=function(parameterStore){return parameterStore.getParametersValues(DefaultHeaderKeys).then(function(parameters){return Object.keys(parameters).forEach(function(key){var value=parameters[key];null!=value&&(parameters[key]=""+value)}),parameters})},BaseWebservice.prototype.getBody=function(parameterStore){var _this=this;return this.getHeaders(parameterStore).then(function(h){return __assign({},_this.getQuery(),{ids:h})})},BaseWebservice.prototype.getBaseURL=function(){return BaseURL+this.getURLShortname()},BaseWebservice.prototype.getQuery=function(){throw new Error("BaseWebservice subclasses should override getQuery()")},BaseWebservice.prototype.getURLShortname=function(){throw new Error("BaseWebservice subclasses should override getURLShortname()")},BaseWebservice}();exports.default=BaseWebservice},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),function(ProfileKeys){ProfileKeys.InstallationID="di",ProfileKeys.CustomIdentifier="cus",ProfileKeys.UserRegion="ure",ProfileKeys.UserLanguage="ula",ProfileKeys.UserProfileVersion="upv",ProfileKeys.Subscription="subscription",ProfileKeys.Subscribed="subscribed",ProfileKeys.LastConfiguration="lastconfig"}(exports.ProfileKeys||(exports.ProfileKeys={}))},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),function(SystemKeys){SystemKeys.SDKAPILevel="lvl",SystemKeys.DeviceTimezone="dtz",SystemKeys.DeviceTimezoneOffset="dtzo",SystemKeys.DeviceDate="da",SystemKeys.DeviceLanguage="dla"}(exports.SystemKeys||(exports.SystemKeys={}))},,function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var keys_profile_1=__webpack_require__(18),keys_session_1=__webpack_require__(22),keys_system_1=__webpack_require__(19);function getValuesArrayForStringEnum(e){return Object.keys(e).map(function(key){return e[key]})}exports.allowedKeyByProvider={profile:getValuesArrayForStringEnum(keys_profile_1.ProfileKeys),session:getValuesArrayForStringEnum(keys_session_1.SessionKeys),system:getValuesArrayForStringEnum(keys_system_1.SystemKeys)},exports.keysByProvider={profile:keys_profile_1.ProfileKeys,session:keys_session_1.SessionKeys,system:keys_system_1.SystemKeys}},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),function(SessionKeys){SessionKeys.SessionID="sessionId"}(exports.SessionKeys||(exports.SessionKeys={}))},function(module,exports,__webpack_require__){"use strict";var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:!0});var deep_obj_compare_1=__importDefault(__webpack_require__(8)),indexed_db_1=__importDefault(__webpack_require__(24)),session_1=__importDefault(__webpack_require__(26)),keys_1=__webpack_require__(21),profile_parameter_provider_1=__importDefault(__webpack_require__(27)),session_parameter_provider_1=__importDefault(__webpack_require__(28)),system_parameter_provider_1=__importDefault(__webpack_require__(29)),storeInstance=null,ParameterStore=function(){function ParameterStore(p){this.providers=p}return ParameterStore.prototype.getParameterValue=function(key){return-1!==keys_1.allowedKeyByProvider.system.indexOf(key)?this.providers.system.getParameterForKey(key):-1!==keys_1.allowedKeyByProvider.profile.indexOf(key)?this.providers.profile.getParameterForKey(key):-1!==keys_1.allowedKeyByProvider.session.indexOf(key)?this.providers.session.getParameterForKey(key):Promise.reject(key+" is not a managed key")},ParameterStore.prototype.setParameterValue=function(key,value){return-1!==keys_1.allowedKeyByProvider.profile.indexOf(key)?this.providers.profile.setParameterForKey(key,value):-1!==keys_1.allowedKeyByProvider.session.indexOf(key)?this.providers.session.setParameterForKey(key,value):Promise.reject(key+" is not a writtable key")},ParameterStore.prototype.setParameterValueIfChanged=function(key,value){var _this=this;return new Promise(function(resolve,reject){_this.getParameterValue(key).then(function(oldValue){deep_obj_compare_1.default(oldValue,value)?resolve(!1):_this.setParameterValue(key,value).then(function(){return resolve(!0)}).catch(reject)},function(error){reject(error)})})},ParameterStore.prototype.getParametersValues=function(keys){var _this=this,promises=keys.map(function(key){return _this.getParameterValue(key)});return Promise.all(promises).then(function(values){return values.reduce(function(acc,cur,indice){return acc[keys[indice]]=cur,acc},{})})},ParameterStore.getInstance=function(){return new Promise(function(resolve){storeInstance instanceof ParameterStore?resolve(storeInstance):indexed_db_1.default.getInstance().then(function(IndexedDb){storeInstance=new ParameterStore({profile:new profile_parameter_provider_1.default(IndexedDb),session:new session_parameter_provider_1.default(new session_1.default),system:new system_parameter_provider_1.default}),resolve(storeInstance)})})},ParameterStore}();exports.default=ParameterStore},function(module,exports,__webpack_require__){"use strict";var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:!0});var batch_error_1=__importDefault(__webpack_require__(25)),dbInstance=null,IndexedDbPersistence=function(){function IndexedDbPersistence(db){if(!(db instanceof IDBDatabase))throw new batch_error_1.default("Unable to setup indexed db");this.db=db}return IndexedDbPersistence.prototype.getData=function(key){var _this=this;return new Promise(function(resolve,reject){var query=_this.db.transaction(["BatchKVData"]).objectStore("BatchKVData").get(key);query.onerror=reject,query.onsuccess=function(event){var data=event.target.result;resolve(void 0===data?null:data.value)}})},IndexedDbPersistence.prototype.setData=function(key,value){var _this=this;return new Promise(function(resolve,reject){var query=_this.db.transaction(["BatchKVData"],"readwrite").objectStore("BatchKVData").put({k:key,value:value});query.onerror=reject,query.onsuccess=function(){return resolve(value)}})},IndexedDbPersistence.getInstance=function(){return new Promise(function(resolve,reject){if(dbInstance instanceof IndexedDbPersistence)resolve(dbInstance);else{indexedDB||reject(new Error("IndexedDB not available"));var request=indexedDB.open("BatchWebPush",1);request.onerror=function(err){reject(err)},request.onsuccess=function(event){var db=event.target.result;dbInstance=new IndexedDbPersistence(db),resolve(dbInstance)},request.onupgradeneeded=function(event){event.target.result.createObjectStore("BatchKVData",{keyPath:"k"})}}})},IndexedDbPersistence}();exports.default=IndexedDbPersistence},function(module,exports,__webpack_require__){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var BatchError=function(_super){function BatchError(){return null!==_super&&_super.apply(this,arguments)||this}return __extends(BatchError,_super),BatchError}(Error);exports.default=BatchError},function(module,exports,__webpack_require__){"use strict";var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:!0});var safeWindow=__importDefault(__webpack_require__(4)).default(),Session=function(){function Session(){}return Session.prototype.getData=function(key){return null==safeWindow?Promise.reject("No session storage available"):new Promise(function(resolve){return resolve(safeWindow.sessionStorage.getItem(key))})},Session.prototype.setData=function(key,value){return null==safeWindow?Promise.reject("No session storage available"):new Promise(function(resolve){safeWindow.sessionStorage.setItem(key,value),resolve(value)})},Session}();exports.default=Session},function(module,exports,__webpack_require__){"use strict";var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:!0});var keys_1=__webpack_require__(21),batch_error_1=__importDefault(__webpack_require__(25)),ProfileParameterProvider=function(){function ProfileParameterProvider(storageProvider){this.storage=storageProvider}return ProfileParameterProvider.prototype.getParameterForKey=function(key){if(-1!==keys_1.allowedKeyByProvider.profile.indexOf(key))return this.storage.getData(key);throw new batch_error_1.default(key+" is not a managed profile key")},ProfileParameterProvider.prototype.setParameterForKey=function(key,value){if(-1!==keys_1.allowedKeyByProvider.profile.indexOf(key))return this.storage.setData(key,value);throw new batch_error_1.default(key+" is not a managed profile key")},ProfileParameterProvider}();exports.default=ProfileParameterProvider},function(module,exports,__webpack_require__){"use strict";var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:!0});var keys_1=__webpack_require__(21),batch_error_1=__importDefault(__webpack_require__(25)),SessionParameterProvider=function(){function SessionParameterProvider(storageProvider){this.storage=storageProvider}return SessionParameterProvider.prototype.getParameterForKey=function(key){if(-1!==keys_1.allowedKeyByProvider.session.indexOf(key))return this.storage.getData("com.batch."+key);throw new batch_error_1.default(key+" is not a managed session key")},SessionParameterProvider.prototype.setParameterForKey=function(key,value){if(-1!==keys_1.allowedKeyByProvider.session.indexOf(key))return this.storage.setData("com.batch."+key,value);throw new batch_error_1.default(key+" is not a managed session key")},SessionParameterProvider}();exports.default=SessionParameterProvider},function(module,exports,__webpack_require__){"use strict";var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:!0});var config_1=__webpack_require__(1),keys_system_1=__webpack_require__(19),batch_error_1=__importDefault(__webpack_require__(25)),window_1=__importDefault(__webpack_require__(4)),SystemParameterProvider=function(){function SystemParameterProvider(){}return SystemParameterProvider.prototype.getParameterForKey=function(key){return new Promise(function(resolve){switch(key){case keys_system_1.SystemKeys.SDKAPILevel:resolve(config_1.SDK_API_LVL);break;case keys_system_1.SystemKeys.DeviceTimezone:resolve(SystemParameterProvider.getTimezone());break;case keys_system_1.SystemKeys.DeviceTimezoneOffset:resolve((new Date).getTimezoneOffset().toString());break;case keys_system_1.SystemKeys.DeviceLanguage:var safeWindow=window_1.default();resolve(null!=safeWindow?safeWindow.navigator.language:"");break;case keys_system_1.SystemKeys.DeviceDate:resolve((new Date).toISOString());break;default:throw new batch_error_1.default(key+" is not a managed system key")}})},SystemParameterProvider.getTimezone=function(){if(self.Intl){var autoTZ=self.Intl.DateTimeFormat().resolvedOptions().timeZone;if(autoTZ)return autoTZ}return null},SystemParameterProvider}();exports.default=SystemParameterProvider},function(module,exports,__webpack_require__){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=y[2&op[0]?"return":op[0]?"throw":"next"])&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[0,t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=(t=_.trys).length>0&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var logger_1=__webpack_require__(3),WebserviceExecutor=function(){function WebserviceExecutor(apiKey,subdomain,authKey,devMode,referrer,parameterStore){this.apiKey=apiKey,this.subdomain=subdomain,this.authKey=authKey,this.devMode=devMode,this.referrer=referrer,this.parameterStore=parameterStore}return WebserviceExecutor.prototype.start=function(ws){return __awaiter(this,void 0,void 0,function(){var options,body,URL_1,response,error_1;return __generator(this,function(_a){switch(_a.label){case 0:if("undefined"==typeof fetch)return[2,Promise.reject(new Error("fetch API isn't available"))];options={body:"",cache:"no-cache",credentials:"omit",headers:new Headers({Accept:"application/json","Content-Type":"application/json"}),method:"POST",mode:"cors"},this.devMode||"string"!=typeof this.authKey||options.headers.set("X-Batch-Auth",this.authKey),this.devMode&&options.headers.set("X-Batch-Dev","true"),this.referrer&&options.headers.set("X-Batch-Referer",this.referrer),_a.label=1;case 1:return _a.trys.push([1,4,,5]),[4,ws.getBody(this.parameterStore)];case 2:return body=_a.sent(),options.body=JSON.stringify(body),URL_1=ws.getBaseURL()+"/"+this.apiKey,logger_1.Log.grouped(logger_1.LogLevel.Info,"WSExecutor","Calling WS",["URL: "+URL_1,body,options]),[4,fetch(URL_1,options)];case 3:if(!(response=_a.sent()).ok)throw new Error('Response not ok. Status text: "'+response.statusText+'"');return logger_1.Log.grouped(logger_1.LogLevel.Info,"WSExecutor","WS finished successfuly",["Status text: "+response.statusText]),[2,!0];case 4:throw error_1=_a.sent(),logger_1.Log.error("WSExecutor","Error while executing WS",error_1),error_1;case 5:return[2]}})})},WebserviceExecutor}();exports.default=WebserviceExecutor},,,,function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.urlBase64ToUint8Array=function(base64String){for(var base64=(base64String+"=".repeat((4-base64String.length%4)%4)).replace(/-/g,"+").replace(/_/g,"/"),rawData=self.atob(base64),outputArray=new Uint8Array(rawData.length),i=0;i<rawData.length;i+=1)outputArray[i]=rawData.charCodeAt(i);return outputArray}},,,,,,,,,,,,,,function(module,exports,__webpack_require__){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=y[2&op[0]?"return":op[0]?"throw":"next"])&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[0,t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=(t=_.trys).length>0&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}},__importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}},_this=this;Object.defineProperty(exports,"__esModule",{value:!0});var config_1=__webpack_require__(1),event_1=__importDefault(__webpack_require__(11)),event_names_1=__webpack_require__(13),event_tracker_1=__importDefault(__webpack_require__(14)),push_helper_1=__webpack_require__(34),logger_1=__webpack_require__(3),receiver_1=__importDefault(__webpack_require__(49)),keys_profile_1=__webpack_require__(18),parameter_store_1=__importDefault(__webpack_require__(23)),executor_1=__importDefault(__webpack_require__(30)),executor_stub_1=__importDefault(__webpack_require__(51));logger_1.Log.name="ServiceWorker",(config_1.IS_DEV||!0===self.batchSDK_enable_debug_logging)&&(logger_1.Log.level=logger_1.LogLevel.Debug,logger_1.Log.enableModule("*"));var moduleName="ServiceWorker",getLastKnownGoodConfiguration=function(){return parameter_store_1.default.getInstance().then(function(db){return db.getParameterValue(keys_profile_1.ProfileKeys.LastConfiguration)}).then(function(config){if("object"!=typeof config)throw new Error("Last config is missing or is not an object");if(!config.apiKey)throw new Error("Configuration error: 'apiKey' is mandatory");if(!config.subdomain)throw new Error("Configuration error: 'subdomain' is mandatory");if(!config.authKey)throw new Error("Configuration error: 'authKey' is mandatory");return"boolean"!=typeof config.dev&&(config.dev=!1),config})},getEventTracker=function(){return Promise.all([parameter_store_1.default.getInstance(),getLastKnownGoodConfiguration()]).then(function(results){var referrer,db=results[0],config=results[1];if(logger_1.Log.debug(moduleName,"Loaded config",db,config),!db||"object"!=typeof config)throw new Error("Unexpected error: Invalid promise result. ParameterStore and getLastKnownGoodConfiguration should not be undefined or null");return config.internal&&config.internal.referrer&&(referrer=config.internal.referrer),new event_tracker_1.default(new executor_1.default(config.apiKey,config.subdomain,config.authKey,config.dev,referrer,db))}).catch(function(e){return logger_1.Log.error(moduleName,"Error while getting the WS executor with the real configuration. Returning an event tracker with a stub executor. Error:",e),new event_tracker_1.default(new executor_stub_1.default)})},messageEventReceived=function(event){switch(event.data){case"init":logger_1.Log.debug(moduleName,"Batch initialzied");break;case"start":logger_1.Log.debug(moduleName,"send start");break;case"pushToken":logger_1.Log.debug(moduleName,"change pushtoken");break;case"testBroadcast":message="broad cast",self.clients.matchAll().then(function(clients){clients.forEach(function(client){client.postMessage(message)})});break;default:logger_1.Log.debug(moduleName,"unhandled message")}var message};self.handleBatchSDKEvent=function(eventName,event){switch(eventName){case"pushsubscriptionchange":return function(event){return Promise.all([parameter_store_1.default.getInstance(),getLastKnownGoodConfiguration()]).then(function(results){return __awaiter(_this,void 0,void 0,function(){var db,config,subOptions,pubKey,sub,eventTracker,params,err_1;return __generator(this,function(_a){switch(_a.label){case 0:if(db=results[0],config=results[1],subOptions=null,event.oldSubscription&&event.oldSubscription.options?subOptions=event.oldSubscription.options:config.vapidPublicKey?(pubKey=push_helper_1.urlBase64ToUint8Array(config.vapidPublicKey),subOptions={applicationServerKey:pubKey,userVisibleOnly:!0}):logger_1.Log.error(moduleName,"No 'vapidPublicKey' found in config"),!subOptions)return[3,9];logger_1.Log.debug(moduleName,"Updating registration"),_a.label=1;case 1:return _a.trys.push([1,8,,9]),[4,self.registration.pushManager.subscribe(subOptions)];case 2:return(sub=_a.sent())?[4,db.setParameterValue(keys_profile_1.ProfileKeys.Subscribed,!0)]:[3,6];case 3:return _a.sent(),[4,db.setParameterValue(keys_profile_1.ProfileKeys.Subscription,sub.toJSON())];case 4:return _a.sent(),[4,getEventTracker()];case 5:return eventTracker=_a.sent(),params={from_change_event:!0,token:{protocol:"WPP",subscription:sub}},config.internal&&config.internal.referrer&&(params.referrer=config.internal.referrer),eventTracker.track(new event_1.default(event_names_1.InternalSDKEvent.Subscribed,params)),[3,7];case 6:throw new Error("null subscription");case 7:return[3,9];case 8:return err_1=_a.sent(),logger_1.Log.error(moduleName,"Could not update subscription: ",err_1),[3,9];case 9:return[2]}})})}).catch(function(err){logger_1.Log.error(moduleName,"Could not handle pushsubscriptionchange: ",err)})}(event);case"install":self.skipWaiting();break;case"push":return function(event){return Promise.resolve().then(function(){logger_1.Log.debug(moduleName,"Got a push event",event);var notificationPayload=null;try{if(!event.data)throw new Error("No event data");notificationPayload=event.data.json()}catch(err){logger_1.Log.debug(moduleName,"Notification has no valid JSON payload: not a Batch push")}return"object"==typeof notificationPayload&&receiver_1.default.isBatchPushPayload(notificationPayload)?(logger_1.Log.info(moduleName,"Notification event is a Batch push",event),receiver_1.default.getInstance(parameter_store_1.default.getInstance()).then(function(receiver){if(!receiver.shouldDisplayNotifications())return logger_1.Log.info(moduleName,"User is not registred",event),Promise.resolve();var notificationData=null!=notificationPayload?receiver.getNotificationData(notificationPayload):null;return notificationData?self.registration.showNotification(notificationData.title,notificationData.params).then(function(){logger_1.Log.info(moduleName,"Notification displayed",notificationData)}).catch(function(err){logger_1.Log.error(moduleName,"Error while displaying the notification",err,notificationData)}):(logger_1.Log.error(moduleName,"Failed to generate push notification data"),Promise.resolve())}).catch(function(err){logger_1.Log.error(moduleName,"Error while displaying push:",err)})):(logger_1.Log.debug(moduleName,"Notification is not a Batch push"),Promise.resolve())}).catch(function(err){logger_1.Log.error(moduleName,"Unexpected error while handling pushEvent",err)})}(event);case"notificationclick":return function(event){return Promise.resolve().then(function(){return logger_1.Log.debug(moduleName,"Got a notification click event",event),event&&event.notification&&receiver_1.default.isBatchPushPayload(event.notification.data)?(event.notification.close?event.notification.close():logger_1.Log.error(moduleName,"Could not close the notification"),receiver_1.default.getInstance(parameter_store_1.default.getInstance()).then(function(receiver){return getEventTracker().then(function(tracker){return receiver.handleNotificationClickEvent(event,tracker).catch(function(err){logger_1.Log.debug(moduleName,"Error while handling notification click event",err)})})}).catch(function(err){logger_1.Log.error(moduleName,"Error while handling notification click:",err)})):Promise.resolve()}).catch(function(err){logger_1.Log.error(moduleName,"Unexpected error while handling notificationClickEvent",err)})}(event);case"message":messageEventReceived(event);break;default:logger_1.Log.debug(moduleName,"Got an unhandled event",eventName)}return Promise.resolve()}},function(module,exports,__webpack_require__){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=y[2&op[0]?"return":op[0]?"throw":"next"])&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[0,t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=(t=_.trys).length>0&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}},__importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:!0});var event_1=__importDefault(__webpack_require__(11)),event_names_1=__webpack_require__(13),logger_1=__webpack_require__(3),keys_profile_1=__webpack_require__(18),payload_1=__webpack_require__(50),moduleName="NotificationReceiver",NotificationReceiver=function(){function NotificationReceiver(lastConfig,subscribed){NotificationReceiver.isConfigValid(lastConfig)?("boolean"!=typeof lastConfig.dev&&(lastConfig.dev=!1),this.lastKnownConfiguration=lastConfig):this.lastKnownConfiguration=null,this.isSubscribed=subscribed}return NotificationReceiver.getInstance=function(parameterStorePromise){return __awaiter(this,void 0,void 0,function(){var parameters;return __generator(this,function(_a){switch(_a.label){case 0:return _a.trys.push([0,3,,4]),[4,parameterStorePromise];case 1:return[4,_a.sent().getParametersValues([keys_profile_1.ProfileKeys.LastConfiguration,keys_profile_1.ProfileKeys.Subscribed])];case 2:return[2,new NotificationReceiver((parameters=_a.sent())[keys_profile_1.ProfileKeys.LastConfiguration],parameters[keys_profile_1.ProfileKeys.Subscribed])];case 3:return _a.sent(),[2,new NotificationReceiver(null,!1)];case 4:return[2]}})})},NotificationReceiver.isConfigValid=function(config){if(config){var _a=config,apiKey=_a.apiKey,subdomain=_a.subdomain,authKey=_a.authKey;return"string"==typeof apiKey&&"string"==typeof subdomain&&"string"==typeof authKey}return!1},NotificationReceiver.prototype.shouldDisplayNotifications=function(){return this.isSubscribed},NotificationReceiver.isBatchPushPayload=function(payload){return"object"==typeof payload&&payload_1.Payload.hasEssentialKeys(payload)},NotificationReceiver.prototype.getNotificationData=function(rawPayload){logger_1.Log.debug(moduleName,"Raw payload",rawPayload);try{var configSmallIcon=void 0;this.lastKnownConfiguration&&"string"==typeof this.lastKnownConfiguration.smallIcon&&(configSmallIcon=this.lastKnownConfiguration.smallIcon);var configIcon=void 0;this.lastKnownConfiguration&&"string"==typeof this.lastKnownConfiguration.defaultIcon&&(configIcon=this.lastKnownConfiguration.defaultIcon);var p=new payload_1.Payload(rawPayload),notificationData={params:{actions:p.getActions().map(function(a,i){return{action:"batch-action::"+i,icon:a.iconURL,title:a.label}}),badge:p.getBadgeImageURL()||configSmallIcon,body:p.getBody(),data:rawPayload,icon:p.getIconURL()||configIcon,image:p.getImageURL(),renotify:p.shouldRenotify(),requireInteraction:p.requireInteraction()||!1,tag:p.getTag()},title:p.getTitle()};return logger_1.Log.debug(moduleName,"Notification data",notificationData),notificationData}catch(err){return void logger_1.Log.error(moduleName,"Error while creating the notification:",err)}},NotificationReceiver.prototype.handleNotificationClickEvent=function(ne,eventTracker){var payload;try{if(!ne||!ne.notification||!ne.notification.data)throw new Error("NotificationEvent lacks essential information");payload=new payload_1.Payload(ne.notification.data)}catch(err){return logger_1.Log.error(moduleName,"Error while handling the notification click event",err),Promise.reject(err)}var actionString=ne.action;logger_1.Log.debug(moduleName,"Handle notification click event:",actionString,ne.notification),eventTracker&&eventTracker.track(new event_1.default(event_names_1.InternalSDKEvent.PushOpen,{i:payload.getSendID(),od:payload.getOpenData()}));var action=null;if(actionString&&actionString.startsWith("batch-action::")){var actionIndex=parseInt(actionString.substring("batch-action::".length),10);isNaN(actionIndex)||(action=(action=payload.getActions()[actionIndex])||null)}if(action||(action=payload.getDefaultAction()),action||((action=new payload_1.Action).action="batch.deeplink",action.args={l:"auto",newTab:!1}),!action)return logger_1.Log.error(moduleName,"Empty action, not doing anything"),Promise.reject("Empty action");try{return this.performAction(action)}catch(err){return logger_1.Log.error(moduleName,"Could not execute notification click action",err),Promise.reject(err)}},NotificationReceiver.prototype.performAction=function(action){if("batch.deeplink"===action.action){var deeplink=action.args.l,targetHref="";try{targetHref=new URL(deeplink).href}catch(_a){try{if(!this.lastKnownConfiguration||!this.lastKnownConfiguration.internal)throw new Error("No internal config object");var origin=this.lastKnownConfiguration.internal.origin;if(!origin)throw new Error("No origin in last known configuration");targetHref=new URL(origin).href}catch(err){throw logger_1.Log.error(moduleName,"No origin to fall back on after a lack of default action",err),new Error("Could not open notification: Internal/database error (10)")}}if(targetHref){var newTab="boolean"==typeof action.args.newTab&&action.args.newTab;return this.openURL(targetHref,newTab)}throw new Error("Could not open notification: Internal error (11)")}throw new Error("Unsupported action "+action.action)},NotificationReceiver.prototype.openURL=function(url,forceNewTab){return forceNewTab?(self.clients.openWindow(url),Promise.resolve()):self.clients.matchAll({includeUncontrolled:!0,type:"window"}).then(function(clients){var firstClient=clients.filter(function(client){return client instanceof WindowClient&&((!client.frameType||"top-level"===client.frameType)&&!(Array.isArray(client.ancestorOrigins)&&client.ancestorOrigins.length>0))})[0];if(!firstClient)throw new Error("There is no currently opened page for this service worker");return firstClient.focus(),firstClient.navigate(url),Promise.resolve()}).catch(function(err){return logger_1.Log.debug(moduleName,"Could not open deeplink in currently opened page",err),self.clients.openWindow(url),Promise.resolve()})},NotificationReceiver}();exports.default=NotificationReceiver},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var Action=function(){function Action(){}return Action.fromJSON=function(json){return Object.assign(new Action,JSON.parse(json))},Action.prototype.toJSONString=function(){return JSON.stringify(Object.assign({},this))},Action}();exports.Action=Action;var Payload=function(){function Payload(rawPayload){if(null==rawPayload)throw new Error("Push payload cannot be null");if(this.rawPayload=rawPayload||{},!Payload.hasEssentialKeys(this.rawPayload))throw new Error("Push payload lacks essential keys. It is probably not a Batch push payload.");this.batchPayload=this.rawPayload["com.batch"]}return Payload.hasEssentialKeys=function(payload){return"object"==typeof payload["com.batch"]&&"string"==typeof payload.title&&payload.title.length>0&&"string"==typeof payload.alert&&payload.alert.length>0&&"object"==typeof payload["com.batch"].da},Payload.prototype.enforceString=function(val){return"string"==typeof val?val:void 0},Payload.prototype.getTitle=function(){return this.rawPayload.title},Payload.prototype.getBody=function(){return this.rawPayload.alert},Payload.prototype.getIconURL=function(){return this.enforceString(this.batchPayload.icu)},Payload.prototype.getImageURL=function(){return this.enforceString(this.batchPayload.imu)},Payload.prototype.getBadgeImageURL=function(){return this.enforceString(this.batchPayload.siu)},Payload.prototype.getTag=function(){return this.enforceString(this.batchPayload.ni)},Payload.prototype.shouldRenotify=function(){var rn=this.batchPayload.rn;if("boolean"==typeof rn)return rn},Payload.prototype.requireInteraction=function(){var rn=this.batchPayload.ri;if("boolean"==typeof rn)return rn},Payload.prototype.getDefaultAction=function(){var rawAction=this.batchPayload.da,actionString=rawAction.a;if("string"!=typeof actionString||0===actionString.length)return null;var action=new Action;return action.label="",action.iconURL="",action.action=actionString,action.args="object"==typeof rawAction.args?rawAction.args:{},action},Payload.prototype.getActions=function(){var _this=this,rawActions=this.batchPayload.aa;return Array.isArray(rawActions)?rawActions.map(function(a){var action=new Action,actionString=a.a,label=a.l;return"string"!=typeof actionString||0===actionString.length||"string"!=typeof label||0===label.length?null:(action.label=label,action.action=actionString,action.iconURL=_this.enforceString(a.i),action.args="object"==typeof a.args?a.args:{},action)}).filter(function(a){return null!=a}):[]},Payload.prototype.getSendID=function(){return this.batchPayload.i},Payload.prototype.getOpenData=function(){var od=this.batchPayload.od;if("object"==typeof od)return od},Payload.prototype.shouldSendReadReceipt=function(){return!!this.batchPayload.rr},Payload}();exports.Payload=Payload,exports.default=Payload},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var StubWebserviceExecutor=function(){function StubWebserviceExecutor(){}return StubWebserviceExecutor.prototype.start=function(ws){return Promise.resolve(!0)},StubWebserviceExecutor}();exports.default=StubWebserviceExecutor}]);